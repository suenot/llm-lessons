# Урок 4: Инструменты (Tools) в SmolaGents

## Что такое инструменты (tools)

**Инструменты (tools)** в SmolaGents - это функции, которые агент может вызывать для выполнения конкретных задач. Инструменты позволяют агенту взаимодействовать с внешним миром и расширяют его возможности за пределы простой генерации текста.

Типы инструментов:
- Математические вычисления
- Работа с датой и временем
- Поиск информации
- Доступ к внешним API
- Работа с файлами и данными
- Преобразование и обработка текста

## Создание инструментов с декоратором @tool

Самый простой способ создать инструмент в SmolaGents - использовать декоратор `@tool`:

```python
from smolagents import tool

@tool
def калькулятор(выражение: str) -> str:
    """
    Вычисляет математическое выражение.
    
    Args:
        выражение: Математическое выражение для вычисления
    """
    try:
        result = eval(выражение)
        return f"Результат: {result}"
    except Exception as e:
        return f"Ошибка при вычислении: {str(e)}"
```

Декоратор `@tool` автоматически:
1. Преобразует функцию в объект инструмента
2. Извлекает документацию и типы аргументов
3. Регистрирует инструмент для использования агентом

## Важность документации и типизации

Для эффективной работы агента критически важно правильно документировать инструменты:

```python
@tool
def перевести_валюту(сумма: float, из_валюты: str, в_валюту: str) -> str:
    """
    Конвертирует сумму из одной валюты в другую по текущему курсу.
    
    Args:
        сумма: Сумма денег для конвертации
        из_валюты: Исходная валюта (например, USD, EUR, RUB)
        в_валюту: Целевая валюта (например, USD, EUR, RUB)
    """
    # Реализация...
```

Важные компоненты документации:
1. **Краткое описание** - что делает инструмент
2. **Аргументы** - что принимает инструмент
3. **Типы данных** - какие типы аргументов ожидаются
4. **Описание аргументов** - для чего нужен каждый аргумент
5. **Возвращаемое значение** - что возвращает инструмент

## Создание класса Tool вручную

В некоторых случаях может потребоваться создать инструмент вручную без использования декоратора:

```python
from smolagents import Tool

def поиск_информации(запрос: str) -> str:
    """
    Выполняет поиск информации по запросу.
    
    Args:
        запрос: Текст запроса для поиска
    """
    # Реализация...
    return f"Результаты поиска по запросу: {запрос}"

# Создание инструмента вручную
search_tool = Tool(
    func=поиск_информации,
    name="поиск_информации",  # Можно переопределить имя
    description="Инструмент для поиска информации в интернете"  # Можно переопределить описание
)
```

## Добавление инструментов к агентам

### Добавление при создании агента

```python
from smolagents import ToolCallingAgent, LiteLLMModel, tool

@tool
def время() -> str:
    """Возвращает текущее время."""
    from datetime import datetime
    return datetime.now().strftime("%H:%M:%S")

@tool
def дата() -> str:
    """Возвращает текущую дату."""
    from datetime import datetime
    return datetime.now().strftime("%d.%m.%Y")

# Создание агента с инструментами
agent = ToolCallingAgent(
    tools=[время, дата],
    model=LiteLLMModel(model_id="openrouter/openai/gpt-3.5-turbo")
)
```

### Добавление инструментов к существующему агенту

В SimpleAgent из нашего проекта инструменты можно добавить после создания агента:

```python
from module.agents import SimpleAgent, tool

agent = SimpleAgent()

@tool
def погода(город: str) -> str:
    """
    Возвращает текущую погоду в указанном городе.
    
    Args:
        город: Название города
    """
    return f"В городе {город} сейчас солнечно, +25°C"

# Добавление инструмента к агенту
agent.add_tools([погода])
```

## Группировка инструментов по категориям

Инструменты можно группировать по категориям для лучшей организации:

```python
from module.agents import SimpleAgent, tool

agent = SimpleAgent()

# Математические инструменты
@tool
def сложение(a: float, b: float) -> str:
    """Складывает два числа."""
    return f"Результат: {a + b}"

@tool
def вычитание(a: float, b: float) -> str:
    """Вычитает второе число из первого."""
    return f"Результат: {a - b}"

# Инструменты для работы с текстом
@tool
def верхний_регистр(текст: str) -> str:
    """Преобразует текст в верхний регистр."""
    return текст.upper()

@tool
def нижний_регистр(текст: str) -> str:
    """Преобразует текст в нижний регистр."""
    return текст.lower()

# Добавление инструментов по категориям
math_tools = [сложение, вычитание]
text_tools = [верхний_регистр, нижний_регистр]

agent.add_tools(math_tools)
agent.add_tools(text_tools)
```

## Передача параметров инструментам

При работе с инструментами важно правильно обрабатывать параметры:

```python
@tool
def поиск_в_диапазоне(минимум: int = 0, максимум: int = 100, шаг: int = 1) -> str:
    """
    Выполняет поиск в указанном диапазоне чисел.
    
    Args:
        минимум: Минимальное значение (по умолчанию 0)
        максимум: Максимальное значение (по умолчанию 100)
        шаг: Шаг поиска (по умолчанию 1)
    """
    numbers = list(range(минимум, максимум + 1, шаг))
    return f"Найдено {len(numbers)} чисел в диапазоне от {минимум} до {максимум} с шагом {шаг}"
```

Особенности передачи параметров:
1. **Параметры по умолчанию** - позволяют сделать параметры необязательными
2. **Типы параметров** - помогают агенту понять, какие значения нужно передать
3. **Валидация параметров** - всегда проверяйте корректность входных данных

## Обработка ошибок в инструментах

Важно правильно обрабатывать ошибки в инструментах, чтобы агент мог продолжить работу:

```python
@tool
def безопасный_калькулятор(выражение: str) -> str:
    """
    Безопасно вычисляет математическое выражение.
    
    Args:
        выражение: Математическое выражение
    """
    try:
        # Ограничиваем доступные операции для безопасности
        allowed_names = {"abs": abs, "round": round, "min": min, "max": max}
        code = compile(выражение, "<string>", "eval")
        
        for name in code.co_names:
            if name not in allowed_names:
                raise NameError(f"Использование '{name}' запрещено")
                
        result = eval(code, {"__builtins__": {}}, allowed_names)
        return f"Результат: {result}"
    except Exception as e:
        return f"Ошибка при вычислении: {str(e)}"
```

## Асинхронные инструменты

SmolaGents также поддерживает асинхронные инструменты:

```python
import aiohttp
from smolagents import tool

@tool
async def async_погода(город: str) -> str:
    """
    Асинхронно получает информацию о погоде.
    
    Args:
        город: Название города
    """
    async with aiohttp.ClientSession() as session:
        async with session.get(f"https://api.weather.example.com/forecast?city={город}") as response:
            data = await response.json()
            return f"Погода в городе {город}: {data['description']}, {data['temperature']}°C"
```

## Инструменты для работы с веб-API

Пример инструмента для работы с внешним API:

```python
import requests
from smolagents import tool

@tool
def поиск_в_википедии(запрос: str, язык: str = "ru") -> str:
    """
    Ищет информацию в Википедии.
    
    Args:
        запрос: Текст запроса для поиска
        язык: Код языка (ru, en, de и т.д.)
    """
    url = f"https://{язык}.wikipedia.org/w/api.php"
    
    params = {
        "action": "query",
        "format": "json",
        "list": "search",
        "srsearch": запрос
    }
    
    response = requests.get(url, params=params)
    data = response.json()
    
    if "query" in data and "search" in data["query"]:
        results = data["query"]["search"]
        if results:
            top_result = results[0]
            title = top_result["title"]
            snippet = top_result["snippet"].replace("<span class=\"searchmatch\">", "").replace("</span>", "")
            return f"Найдено в Википедии: {title}\n{snippet}"
    
    return f"По запросу '{запрос}' ничего не найдено"
```

## Практическое задание

Создайте набор инструментов для работы с текстом и интегрируйте их в агента SmolaGents:

1. Инструмент для подсчета слов и символов в тексте
2. Инструмент для извлечения ключевых слов из текста
3. Инструмент для генерации короткого резюме текста

Затем протестируйте агента с запросами, которые требуют использования этих инструментов.

Пример решения:

```python
import re
import random
from smolagents import LiteLLMModel, ToolCallingAgent, tool

# Настройка модели
model = LiteLLMModel(model_id="openrouter/openai/gpt-3.5-turbo")

# Инструменты для работы с текстом
@tool
def статистика_текста(текст: str) -> str:
    """
    Подсчитывает количество слов, символов и предложений в тексте.
    
    Args:
        текст: Текст для анализа
    """
    слова = len(re.findall(r'\b\w+\b', текст))
    символы = len(текст)
    символы_без_пробелов = len(текст.replace(" ", ""))
    предложения = len(re.split(r'[.!?]+', текст)) - 1
    
    return f"""Статистика текста:
- Слов: {слова}
- Символов: {символы}
- Символов без пробелов: {символы_без_пробелов}
- Предложений: {предложения}"""

@tool
def ключевые_слова(текст: str, количество: int = 5) -> str:
    """
    Извлекает ключевые слова из текста.
    
    Args:
        текст: Текст для анализа
        количество: Количество ключевых слов для извлечения
    """
    # Это упрощенная реализация для примера
    # В реальном приложении лучше использовать библиотеки NLP
    
    # Удаляем пунктуацию и приводим к нижнему регистру
    текст = re.sub(r'[^\w\s]', '', текст.lower())
    
    # Разбиваем на слова
    слова = текст.split()
    
    # Исключаем стоп-слова (в реальном приложении список будет больше)
    стоп_слова = ["и", "в", "на", "с", "по", "для", "что", "это", "как", "так", "но", "а", "то"]
    отфильтрованные_слова = [слово for слово in слова if слово not in стоп_слова and len(слово) > 2]
    
    # Подсчитываем частоту слов
    частота_слов = {}
    for слово in отфильтрованные_слова:
        частота_слов[слово] = частота_слов.get(слово, 0) + 1
    
    # Сортируем по частоте
    сортированные_слова = sorted(частота_слов.items(), key=lambda x: x[1], reverse=True)
    
    # Берем top-N слов
    топ_слова = сортированные_слова[:количество]
    
    if not топ_слова:
        return "Не удалось извлечь ключевые слова из этого текста."
    
    return "Ключевые слова: " + ", ".join([слово for слово, _ in топ_слова])

@tool
def резюме_текста(текст: str, макс_длина: int = 100) -> str:
    """
    Генерирует короткое резюме текста.
    
    Args:
        текст: Текст для резюмирования
        макс_длина: Максимальная длина резюме в символах
    """
    # Упрощенная реализация для примера
    # В реальном приложении лучше использовать модель суммаризации
    
    # Разбиваем текст на предложения
    предложения = re.split(r'(?<=[.!?])\s+', текст)
    
    if not предложения:
        return "Не удалось создать резюме для этого текста."
    
    # Выбираем первое предложение и, возможно, некоторые другие
    резюме = предложения[0]
    
    # Если первое предложение короткое, добавляем еще одно
    if len(резюме) < макс_длина // 2 and len(предложения) > 1:
        резюме += " " + предложения[1]
    
    # Обрезаем, если превышает максимальную длину
    if len(резюме) > макс_длина:
        резюме = резюме[:макс_длина - 3] + "..."
    
    return f"Резюме: {резюме}"

# Создание агента
agent = ToolCallingAgent(
    tools=[статистика_текста, ключевые_слова, резюме_текста],
    model=model,
    max_steps=5,
    verbosity_level=1
)

# Тестирование агента
пример_текста = """
Искусственный интеллект (ИИ) — это область информатики, которая занимается разработкой интеллектуальных машин, способных выполнять задачи, требующие человеческого интеллекта. 
К таким задачам относятся распознавание речи, принятие решений, перевод текста и распознавание образов. ИИ развивается быстрыми темпами и находит применение в различных сферах, 
включая медицину, финансы, транспорт и развлечения. Основные подходы в ИИ включают машинное обучение, глубокое обучение, нейронные сети и обработку естественного языка.
"""

запросы = [
    f"Посчитай количество слов и символов в следующем тексте: {пример_текста}",
    f"Какие ключевые слова можно выделить из этого текста? {пример_текста}",
    f"Сделай краткое резюме этого текста: {пример_текста}"
]

for запрос in запросы:
    print(f"\nЗапрос: {запрос[:50]}...")
    ответ = agent(запрос)
    print(f"Ответ: {ответ}")
```

## Дополнительные ресурсы

- [Документация по инструментам в SmolaGents](https://github.com/smol-ai/smolagents/blob/main/docs/tools.md)
- [Примеры инструментов](https://github.com/smol-ai/smolagents/tree/main/examples)
- [Документация Pydantic по типизации](https://docs.pydantic.dev/) 